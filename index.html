<script>
    // ===== 請先填入你的 Firebase 專案設定 =====
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 所有人共用的資料集合
    const toTryRef = db.collection('sharedRestaurants').doc('main').collection('toTry');
    const ratedRef = db.collection('sharedRestaurants').doc('main').collection('rated');

    let toTryRestaurants = [];
    let ratedRestaurants = [];
    let editingToTryId = null;
    let editingRatingId = null;

    // ==================== 即時同步資料 ====================
    function loadData() {
        toTryRef.orderBy('dateAdded', 'desc').onSnapshot(snapshot => {
            toTryRestaurants = [];
            snapshot.forEach(doc => {
                toTryRestaurants.push({ id: doc.id, ...doc.data() });
            });
            renderToTryList();
            updateStats();
        });

        ratedRef.orderBy('dateAdded', 'desc').onSnapshot(snapshot => {
            ratedRestaurants = [];
            snapshot.forEach(doc => {
                ratedRestaurants.push({ id: doc.id, ...doc.data() });
            });
            renderRatingList();
            updateStats();
        });
    }

    // ==================== 星級評分初始化 ====================
    function initializeStarRatings() {
        document.querySelectorAll('.star-rating').forEach(container => {
            const stars = container.querySelectorAll('i');
            const input = container.parentElement.querySelector('input[type="hidden"]');

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    input.value = value;
                    updateStars(stars, value);
                });
                star.addEventListener('mouseenter', () => {
                    updateStars(stars, parseInt(star.dataset.value));
                });
            });
            container.addEventListener('mouseleave', () => {
                updateStars(stars, parseInt(input.value) || 0);
            });
        });
    }

    function updateStars(stars, value) {
        stars.forEach((star, i) => {
            if (i < value) {
                star.classList.remove('far');
                star.classList.add('fas', 'active');
            } else {
                star.classList.remove('fas', 'active');
                star.classList.add('far');
            }
        });
    }

    // ==================== 新增想嘗試的餐廳 ====================
    async function addToTryRestaurant(event) {
        event.preventDefault();
        const form = event.target;
        const data = {
            name: form.name.value.trim(),
            cuisine: form.cuisine.value,
            location: form.location.value.trim(),
            price: form.price.value,
            recommendedBy: form['recommended-by'].value.trim(),
            reason: form.reason.value.trim(),
            priority: form.priority.value,
            notes: form.notes.value.trim(),
            dateAdded: editingToTryId 
                ? toTryRestaurants.find(r => r.id === editingToTryId)?.dateAdded || firebase.firestore.FieldValue.serverTimestamp()
                : firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (editingToTryId) {
                await toTryRef.doc(editingToTryId).update(data);
                showSuccess('餐廳資訊已更新！');
                editingToTryId = null;
            } else {
                await toTryRef.add(data);
                showSuccess('已新增想嘗試的餐廳！');
            }
            form.reset();
        } catch (err) {
            alert('發生錯誤，請檢查網路或 Firebase 設定');
            console.error(err);
        }
    }

    // ==================== 新增/更新餐廳評分 ====================
    async function addRating(event) {
        event.preventDefault();
        const form = event.target;
        const data = {
            name: form.name.value.trim(),
            cuisine: form.cuisine.value,
            location: form.location.value.trim(),
            visitDate: form['visit-date'].value || null,
            pricePaid: form['price-paid'].value || null,
            wouldReturn: form['would-return'].value,
            dishes: form.dishes.value.trim(),
            highlights: form.highlights.value.trim(),
            improvements: form.improvements.value.trim(),
            review: form.review.value.trim(),
            overallRating: parseInt(form['overall-rating'].value) || 0,
            foodRating: parseInt(form['food-rating'].value) || 0,
            serviceRating: parseInt(form['service-rating'].value) || 0,
            ambianceRating: parseInt(form['ambiance-rating'].value) || 0,
            valueRating: parseInt(form['value-rating'].value) || 0,
            dateAdded: editingRatingId 
                ? ratedRestaurants.find(r => r.id === editingRatingId)?.dateAdded || firebase.firestore.FieldValue.serverTimestamp()
                : firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (editingRatingId) {
                await ratedRef.doc(editingRatingId).update(data);
                showSuccess('評分已更新！');
                editingRatingId = null;
            } else {
                await ratedRef.add(data);
                showSuccess('已新增餐廳評分！');
            }
            form.reset();
            document.querySelectorAll('.star-rating i').forEach(i => {
                i.classList.remove('fas', 'active');
                i.classList.add('far');
            });
            document.querySelectorAll('input[name$="-rating"]').forEach(i => i.value = '0');
        } catch (err) {
            alert('發生錯誤，請檢查網路或 Firebase 設定');
            console.error(err);
        }
    }

    // ==================== 渲染清單 ====================
    function renderToTryList() {
        const container = document.getElementById('to-try-list');
        const search = document.getElementById('search-to-try').value.toLowerCase();
        const cuisine = document.getElementById('filter-cuisine-to-try').value;
        const sort = document.getElementById('sort-to-try').value;

        let list = toTryRestaurants.filter(r => {
            const matchSearch = r.name.toLowerCase().includes(search) || (r.location && r.location.toLowerCase().includes(search));
            const matchCuisine = !cuisine || r.cuisine === cuisine;
            return matchSearch && matchCuisine;
        });

        // 排序
        list.sort((a, b) => {
            if (sort === 'date-desc') return b.dateAdded?.seconds - a.dateAdded?.seconds || 0;
            if (sort === 'date-asc') return a.dateAdded?.seconds - b.dateAdded?.seconds || 0;
            if (sort === 'name-asc') return a.name.localeCompare(b.name);
            if (sort === 'name-desc') return b.name.localeCompare(a.name);
            if (sort.includes('priority')) {
                const order = { high: 3, medium: 2, low: 1 };
                return sort === 'priority-high' 
                    ? order[b.priority] - order[a.priority]
                    : order[a.priority] - order[b.priority];
            }
            return 0;
        });

        if (list.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="fas fa-utensils"></i><h3>還沒有想嘗試的餐廳</h3><p>開始新增吧！</p></div>`;
            return;
        }

        container.innerHTML = list.map(r => `
            <div class="restaurant-card">
                <div class="card-header"><h3>${r.name}</h3></div>
                <div class="card-badges">
                    <span class="badge badge-cuisine"><i class="fas fa-utensils"></i> ${r.cuisine}</span>
                    <span class="badge badge-price"><i class="fas fa-dollar-sign"></i> ${r.price}</span>
                    <span class="badge-priority ${r.priority}"><i class="fas fa-flag"></i> ${r.priority === 'high' ? '高' : r.priority === 'medium' ? '中' : '低'}優先</span>
                </div>
                <div class="card-info">
                    ${r.location ? `<p><i class="fas fa-map-marker-alt"></i> ${r.location}</p>` : ''}
                    ${r.recommendedBy ? `<p><i class="fas fa-user"></i> 推薦人：${r.recommendedBy}</p>` : ''}
                    ${r.reason ? `<p><i class="fas fa-lightbulb"></i> ${r.reason.substring(0,100)}${r.reason.length>100?'...':''}</p>` : ''}
                </div>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="markAsVisited('${r.id}')"><i class="fas fa-check"></i> 標記已造訪</button>
                    <button class="btn btn-secondary" onclick="editToTry('${r.id}')"><i class="fas fa-edit"></i> 編輯</button>
                    <button class="btn btn-danger" onclick="deleteToTry('${r.id}')"><i class="fas fa-trash"></i> 刪除</button>
                </div>
            </div>
        `).join('');
    }

    function renderRatingList() {
        const container = document.getElementById('rating-list');
        const search = document.getElementById('search-rating').value.toLowerCase();
        const cuisine = document.getElementById('filter-cuisine-rating').value;
        const sort = document.getElementById('sort-rating').value;

        let list = ratedRestaurants.filter(r => {
            const matchSearch = r.name.toLowerCase().includes(search) || (r.location && r.location.toLowerCase().includes(search));
            const matchCuisine = !cuisine || r.cuisine === cuisine;
            return matchSearch && matchCuisine;
        });

        list.sort((a, b) => {
            if (sort === 'date-desc') return (b.visitDate || b.dateAdded?.seconds || 0) - (a.visitDate || a.dateAdded?.seconds || 0);
            if (sort === 'date-asc') return (a.visitDate || a.dateAdded?.seconds || 0) - (b.visitDate || b.dateAdded?.seconds || 0);
            if (sort === 'rating-high') return b.overallRating - a.overallRating;
            if (sort === 'rating-low') return a.overallRating - b.overallRating;
            if (sort === 'name-asc') return a.name.localeCompare(b.name);
            if (sort === 'name-desc') return b.name.localeCompare(a.name);
            return 0;
        });

        if (list.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="fas fa-star"></i><h3>還沒有評分記錄</h3><p>開始記錄用餐體驗吧！</p></div>`;
            return;
        }

        container.innerHTML = list.map(r => `
            <div class="restaurant-card">
                <div class="card-header"><h3>${r.name}</h3></div>
                <div class="rating-display">
                    <div class="rating-stars">${generateStars(r.overallRating)}</div>
                    <span class="rating-value">${r.overallRating}.0 / 5.0</span>
                </div>
                <div class="card-badges">
                    <span class="badge badge-cuisine"><i class="fas fa-utensils"></i> ${r.cuisine}</span>
                    ${r.visitDate ? `<span class="badge badge-price"><i class="fas fa-calendar"></i> ${new Date(r.visitDate).toLocaleDateString('zh-TW')}</span>` : ''}
                </div>
                <div class="card-info">
                    ${r.location ? `<p><i class="fas fa-map-marker-alt"></i> ${r.location}</p>` : ''}
                    ${r.pricePaid ? `<p><i class="fas fa-dollar-sign"></i> 實付：NT$${r.pricePaid}</p>` : ''}
                </div>
                <div class="rating-breakdown">
                    <div class="rating-item"><span>食物</span><span class="rating-item-stars">${generateStars(r.foodRating)}</span></div>
                    <div class="rating-item"><span>服務</span><span class="rating-item-stars">${generateStars(r.serviceRating)}</span></div>
                    <div class="rating-item"><span>環境</span><span class="rating-item-stars">${generateStars(r.ambianceRating)}</span></div>
                    <div class="rating-item"><span>性價比</span><span class="rating-item-stars">${generateStars(r.valueRating)}</span></div>
                </div>
                ${r.wouldReturn ? `<span class="return-badge ${r.wouldReturn}">${r.wouldReturn === 'definitely' ? '✓ 絕對會再訪' : r.wouldReturn === 'maybe' ? '? 可能會' : r.wouldReturn === 'probably-not' ? '✗ 可能不會' : '✗✗ 絕不會'}</span>` : ''}
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="viewFullReview('${r.id}')"><i class="fas fa-eye"></i> 完整評價</button>
                    <button class="btn btn-secondary" onclick="editRating('${r.id}')"><i class="fas fa-edit"></i> 編輯</button>
                    <button class="btn btn-danger" onclick="deleteRating('${r.id}')"><i class="fas fa-trash"></i> 刪除</button>
                </div>
            </div>
        `).join('');
    }

    function generateStars(n) {
        return Array(5).fill().map((_, i) => i < n ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>').join('');
    }

    // ==================== 其他功能 ====================
    async function deleteToTry(id) {
        if (confirm('確定刪除這家餐廳？')) {
            await toTryRef.doc(id).delete();
            showSuccess('已刪除');
        }
    }

    async function deleteRating(id) {
        if (confirm('確定刪除這筆評分？')) {
            await ratedRef.doc(id).delete();
            showSuccess('已刪除');
        }
    }

    function editToTry(id) {
        const r = toTryRestaurants.find(x => x.id === id);
        if (!r) return;
        editingToTryId = id;
        const f = document.getElementById('to-try-form');
        f.name.value = r.name;
        f.cuisine.value = r.cuisine;
        f.location.value = r.location || '';
        f.price.value = r.price;
        f['recommended-by'].value = r.recommendedBy || '';
        f.reason.value = r.reason || '';
        f.priority.value = r.priority;
        f.notes.value = r.notes || '';
        f.scrollIntoView({behavior: 'smooth'});
    }

    function editRating(id) {
        const r = ratedRestaurants.find(x => x.id === id);
        if (!r) return;
        editingRatingId = id;
        const f = document.getElementById('rating-form');
        f.name.value = r.name;
        f.cuisine.value = r.cuisine;
        f.location.value = r.location || '';
        f['visit-date'].value = r.visitDate || '';
        f['price-paid'].value = r.pricePaid || '';
        f['would-return'].value = r.wouldReturn;
        f.dishes.value = r.dishes || '';
        f.highlights.value = r.highlights || '';
        f.improvements.value = r.improvements || '';
        f.review.value = r.review || '';

        ['overall', 'food', 'service', 'ambiance', 'value'].forEach(type => {
            const val = r[`${type}Rating`] || 0;
            f[`${type}-rating`].value = val;
            updateStars(f.querySelectorAll(`.star-rating[data-rating="${type}"] i`), val);
        });

        f.scrollIntoView({behavior: 'smooth'});
    }

    function markAsVisited(id) {
        const r = toTryRestaurants.find(x => x.id === id);
        if (!r) return;
        switchTab('rating');
        const f = document.getElementById('rating-form');
        f.name.value = r.name;
        f.cuisine.value = r.cuisine;
        f.location.value = r.location || '';
        f['visit-date'].value = new Date().toISOString().split('T')[0];
        f.scrollIntoView({behavior: 'smooth'});
        deleteToTry(id); // 自動從想試清單移除
    }

    function viewFullReview(id) {
        const r = ratedRestaurants.find(x => x.id === id);
        if (!r) return;
        const body = document.getElementById('modal-body');
        body.innerHTML = `
            <h2 style="color:var(--coral);margin-bottom:20px;">${r.name}</h2>
            <div class="rating-display" style="margin-bottom:20px;">
                <div class="rating-stars">${generateStars(r.overallRating)}</div>
                <span class="rating-value">${r.overallRating}.0 / 5.0</span>
            </div>
            <!-- 其餘詳細內容同你原本的 modal -->
            ${r.review ? `<p style="white-space:pre-wrap;margin-top:20px;"><strong>整體評價：</strong>${r.review}</p>` : ''}
        `;
        document.getElementById('review-modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('review-modal').classList.remove('active');
    }

    function filterToTry() { renderToTryList(); }
    function filterRatings() { renderRatingList(); }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        if (tab === 'to-try') {
            document.querySelector('.tab:first-child').classList.add('active');
            document.getElementById('to-try-tab').classList.add('active');
        } else {
            document.querySelector('.tab:last-child').classList.add('active');
            document.getElementById('rating-tab').classList.add('active');
        }
    }

    function updateStats() {
        document.getElementById('stat-to-try').textContent = toTryRestaurants.length;
        document.getElementById('stat-rated').textContent = ratedRestaurants.length;
        if (ratedRestaurants.length > 0) {
            const avg = ratedRestaurants.reduce((s, r) => s + r.overallRating, 0) / ratedRestaurants.length;
            document.getElementById('stat-avg-rating').textContent = avg.toFixed(1);
        } else {
            document.getElementById('stat-avg-rating').textContent = '0.0';
        }
        // 最愛料理類型（簡化版）
        const all = [...toTryRestaurants, ...ratedRestaurants];
        if (all.length > 0) {
            const counts = all.reduce((o, r) => { o[r.cuisine] = (o[r.cuisine]||0)+1; return o; }, {});
            const top = Object.keys(counts).sort((a,b) => counts[b]-counts[a])[0];
            document.getElementById('stat-top-cuisine').textContent = top;
        } else {
            document.getElementById('stat-top-cuisine').textContent = '-';
        }
    }

    function showSuccess(msg) {
        const el = document.getElementById('success-message');
        document.getElementById('success-text').textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }

    function toggleTheme() {
        const root = document.documentElement;
        const newTheme = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        const span = document.querySelector('.theme-toggle span');
        const icon = document.querySelector('.theme-toggle i');
        span.textContent = newTheme === 'dark' ? '淺色模式' : '深色模式';
        icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    async function exportData() {
        const toTrySnap = await toTryRef.get();
        const ratedSnap = await ratedRef.get();
        const data = {
            toTryRestaurants: toTrySnap.docs.map(d => ({id: d.id, ...d.data()})),
            ratedRestaurants: ratedSnap.docs.map(d => ({id: d.id, ...d.data()})),
            exportDate: new Date().toISOString()
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `restaurant-backup-${new Date().toISOString().slice(0,10)}.json`;
        a.click(); URL.revokeObjectURL(url);
        showSuccess('資料已匯出！');
    }

    // ==================== 初始化 ====================
    document.addEventListener('DOMContentLoaded', () => {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
        if (theme === 'dark') {
            document.querySelector('.theme-toggle span').textContent = '淺色模式';
            document.querySelector('.theme-toggle i').className = 'fas fa-sun';
        }

        initializeStarRatings();
        loadData(); // 開始即時同步
    });

    // 點擊 modal 背景關閉
    document.getElementById('review-modal').addEventListener('click', e => {
        if (e.target.id === 'review-modal') closeModal();
    });
</script>
